---
 - name: Connect to WSHA
   hosts: restore_wsha_vm
   become: yes

   tasks:
   - name: run script to user & pass
     shell: |
       cd /opt/wavesuite/cp/21.08.0/bin/
       spawn sudo ./update_vault.sh -v
       expect "Vault password: "
       send "qweQWE123!@#\r"
       interact
       exit 0 
     args:
       executable: /usr/bin/expect
     register: output

   - name: Set facts
     set_fact:
       set_output: "{{ output.stdout_lines }}"       

   - name: Show out mariadb_data_replication_user_password
     shell: echo {{ output.stdout_lines[4] }} | cut -c 1-50
     register: mariadb_data

   - name: Print out mariadb_data_replication_user_password
     shell: echo " {{ mariadb_data.stdout }} " > /wshaCredential.txt
   
   - name: Show out influxdb_admin
     shell: echo {{ output.stdout_lines[5] }} | cut -c 1-40
     register: influxdb_admin

   - name: Print out pass admin
     shell: echo " {{ influxdb_admin.stdout }} " >>  /wshaCredential.txt

   - name: Show out influxdb_general
     shell: echo {{ output.stdout_lines[6] }} | cut -c 1-42
     register: influxdb_general

   - name: Print out pass admin
     shell: echo " {{ influxdb_general.stdout }} " >> /wshaCredential.txt

   - name: Show out keycloak_master_realm_admin_password
     shell: echo {{ output.stdout_lines[7] }} | cut -c 1-48
     register: keycloak_master

   - name: Print out pass admin
     shell: echo " {{ keycloak_master.stdout }} " >> /wshaCredential.txt

   - name: Show out mariadb_keycloak_user_password
     shell: echo {{ output.stdout_lines[8] }} | cut -c 1-42
     register: mariadb_keycloak

   - name: Print out pass admin
     shell: echo " {{ mariadb_keycloak.stdout }} " >> /wshaCredential.txt

   - name: Show out mariadb_kong_user_password
     shell: echo {{ output.stdout_lines[9] }} | cut -c 1-38
     register: mariadb_kong  

   - name: Print out pass admin
     shell: echo " {{ mariadb_kong.stdout }} " >> /wshaCredential.txt

   - name: Show out mariadb_root_user_password
     shell: echo {{ output.stdout_lines[10] }} | cut -c 1-38
     register: mariadb_root

   - name: Print out pass adm
     shell: echo " {{ mariadb_root.stdout }} " >> /wshaCredential.txt

   - name: Show out mariadb_wscp_user_password
     shell: echo {{ output.stdout_lines[11] }} | cut -c 1-38
     register: mariadb_wscp

   - name: Print out pass admin
     shell: echo " { mariadb_wscp.stdout }} " >> /wshaCredential.txt
   
   - name: Show out ssl_keystore_password
     shell: echo {{ output.stdout_lines[12] }} | cut -c 1-33
     register: ssl_keystore

   - name: Print out pass admin
     shell: echo " {{ ssl_keystore.stdout }} " >> /wshaCredential.txt

   - name: Show out ssl_truststore_password
     shell: echo {{ output.stdout_lines[13] }} | cut -c 1-35
     register: ssl_truststore

   - name: Print out pass admin
     shell: echo " {{ ssl_truststore.stdout }} " >> /wshaCredential.txt

   - name: Show out wavesuite_admin_password
     shell: echo {{ output.stdout_lines[14] }} | cut -c 1-36
     register: wavesuite_admin

   - name: Print out pass admin
     shell: echo " {{ wavesuite_admin.stdout }} " >> /wshaCredential.txt

   - name: Fetch tenanid to host
     fetch:
      src: /wshaCredential.txt
      dest: ./
      flat: yes

   - name: Delete credential file
     shell: rm -f /wshaCredential.txt   

   - name: Reboot the machine
     shell: systemctl daemon-reload  

 - name: Get URL of WSHA
   hosts: localhost 
   connection: local
   collections:
    - azure.azcollection

   vars:
    new_rg: "{{ lookup('env', 'rg') }}"
    vm_name: "{{ lookup('env', 'wshaname') }}"
 
   tasks:
     - name: Get Public IP of VM
       shell: sudo az vm show -g "{{ new_rg }}" -n "{{ vm_name }}"  --query publicIps -d --out tsv > ./publicip.txt
              
     - name: set credentials
       shell: cat ./wshaCredential.txt
       register: credential 
     
     - name: Get ip public
       shell: awk '{if(NR==1) print $1}' ./publicip.txt
       register: publicip

     - name: Show URL of APP WSHA
       debug:
        msg: " This is URL of WSHA: https://{{ publicip.stdout }}:8443/wavesuite/common/auth/admin/master/console"
   
     - name: Print out Resource Group of New WSHA
       debug:
        msg: " This is Resource Group of New WSHA: {{ new_rg }}"

     - name: Print out VM name of New WSHA
       debug:
        msg: " This is VM name of New WSHA: {{ vm_name }}"

     - name:  Print out Credentials of New WSHA
       debug:
        msg: " {{ credential.stdout_lines }} "
