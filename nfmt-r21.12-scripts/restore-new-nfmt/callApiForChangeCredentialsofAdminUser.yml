---
- name: Call Keycloak API to Change Credentials for Admin User on WSHA Component
  hosts: localhost
  connection: local
  collections:
   - azure.azcollection

  vars: 
    wshaName: "{{ lookup('env', 'wshaname') }}"
    resource_group: "{{ lookup('env', 'rg') }}"

  tasks:
  - name: Query Public IP vm master node
    shell: sudo az vm show -g "{{ resource_group }}" -n "{{ wshaName }}"  --query publicIps -d --out tsv 
    register: wshaIp

  - name: Get keycloack admin password 
    shell: |
      awk '{if(NR==4) print $2}' ./wshaCredential.txt
    register: keycloackaAdminPassword

  - name: Show out keycloackaAdminPassword
    debug:
      msg: "This is keycloackaAdminPassword: {{keycloackaAdminPassword.stdout}}"

  - name: Generate a new password 
    shell: echo "a$(sudo cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 12 | head -n 1)1@" > password.txt

  - name: Set environment variable for password
    shell: cat password.txt
    register: newPassword

  - name: Print out New Password
    debug:
      msg: "This is new Password: {{ newPassword.stdout }}"

  - name: Get token access of admin keycloack
    shell: |
      curl --insecure --location --request POST "https://{{wshaIp.stdout}}:8443/wavesuite/common/auth/realms/master/protocol/openid-connect/token" \
      --header 'Content-Type: application/x-www-form-urlencoded' \
      --data-urlencode 'client_id=admin-cli' \
      --data-urlencode 'username=admin' \
      --data-urlencode "password={{ keycloackaAdminPassword.stdout }}" \
      --data-urlencode 'grant_type=password' | sed -n 's|.*"access_token":"\([^"]*\)".*|\1|p'
    register: token

  - name: Show out token
    debug:
      msg: "This is currently token: {{token.stdout}}"

  - name: Get Netguard Realm Admin's userId
    shell: |
      curl --insecure --location --request GET -H "Content-Type: application/json" -H "Authorization: bearer {{token.stdout}}" "https://{{wshaIp.stdout}}:8443/wavesuite/common/auth/admin/realms/wavesuite/users" | awk -F '["]' '{print $4}' 
    register: userId

  - name: Show out UserId
    debug:
      msg: "This is User ID of Admin: {{userId.stdout}}"

  - name: Reset Netguard Realm Admin's Password 
    shell: |
      curl --insecure --location --request PUT "https://{{wshaIp.stdout}}:8443/wavesuite/common/auth/admin/realms/wavesuite/users/{{userId.stdout}}/reset-password" \
      -H "Authorization: bearer {{ token.stdout }}" \
      --header 'Content-Type: application/json' \
      --data '{"type":"password","value":"{{ newPassword.stdout }}","temporary":false}'
   