---
- name: Recovery Existing WSHA VM
  hosts: localhost
  connection: local
  collections:
   - azure.azcollection

  vars_files:
    env_variables

  tasks:
#  - name: Listing available recovery points
#    shell: sudo az backup recoverypoint list --resource-group "{{ resource_group }}" --vault-name "{{ vaultName }}" --backup-management-type AzureIaasVM --container-name "{{ container_name }}" --item-name "{{ container_name }}" --query [0].name --output tsv
#    register: recoverypoint

  - name: Restore the disk from your recovery point
    shell: sudo az backup restore restore-disks --resource-group "{{ resource_group }}" --vault-name "{{ vaultName }}" --container-name "{{ dpaName }}" --item-name "{{ dpaName }}" --storage-account "{{ storageName }}" --rp-name "{{ dpaRecoveryPoint }}" --target-resource-group "{{ resourceGroup }}" --query name
    register: backupjob

  - name: Pause for 5 minutes for restore disk
    pause:
     minutes: 5
  
  - name: Disable backup of VM
    shell: sudo az backup protection disable --resource-group "{{ resource_group }}" --vault-name "{{ vaultName }}" --container-name "{{ dpaName }}" --item-name "{{ dpaName }}" --backup-management-type AzureIaaSVM -y

  - name: Get new Id disk
    shell: sudo az disk list -g "{{ resourceGroup }}" --query '[?managedBy==`null`].[id]' -o tsv | grep -i "{{ dpaName }}"
    register: newiddisk

  - name: Get old Id disk
    shell: sudo az vm show -d -g "{{ resourceGroup }}" -n "{{ dpaName }}" --query "storageProfile.osDisk.managedDisk.id" | awk -F '[/]' '{print $9}' | sed 's/"//'
    register: oldiddisk

  - name: Stop DPA VM
    shell: sudo az vm stop -n "{{ dpaName }}" -g "{{ resourceGroup }}"

  - name: Swap disk for DPA VM
    shell: sudo az vm update -g "{{ resourceGroup }}" -n "{{ dpaName }}" --os-disk {{ newiddisk.stdout }}

  - name: Start DPA VM
    shell: sudo az vm start -n "{{ dpaName }}" -g "{{ resourceGroup }}"

  - name: Remove Os Disk
    azure_rm_manageddisk:
     name: "{{ oldiddisk.stdout }}"
     location: "{{ location }}"
     resource_group: "{{ resourceGroup }}"
     state: absent
  

