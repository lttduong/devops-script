- name: Create Azure VM
  hosts: localhost
  connection: local
  collections:
   - azure.azcollection

  vars_files:
   - variables_file.yml 

  tasks:
  - name: Create virtual network
    azure_rm_virtualnetwork:
      resource_group: "{{ resource_group }}"
      name: "{{ vnet }}"
      address_prefixes: "{{ vnetCidr}}"
      location: "{{ location }}"

  - name: Add subnet
    azure_rm_subnet:
      resource_group: "{{ resource_group }}"
      name: "{{ subnet }}"
      address_prefix_cidr: "{{ subnetCidr }}"
      virtual_network: "{{ vnet }}"

  - name: Create public IP address
    azure_rm_publicipaddress:
      resource_group: "{{ resource_group }}"
      allocation_method: Static
      name: "{{ nworker }}"
      location: "{{ location }}"
    register: output_ip_address

  - name: Public IP of VM
    debug:
      msg: "The public IP is {{ output_ip_address.state.ip_address }}."

  - name: Create Network Security Group that allows SSH
    azure_rm_securitygroup:
      resource_group: "{{ resource_group }}"
      name: "{{ net_security_group }}"
      location: "{{ location }}"
      rules:
          - name: 'Port_443'
            destination_port_range: 443
            access: Allow
            priority: 320
            direction: Inbound
          - name: 'Allow_SSH'
            protocol: Tcp
            source_address_prefix:
              - '103.199.7.220'
              - '20.123.140.188'
            destination_port_range: 22
            access: Allow
            priority: 330
            direction: Inbound 

  - name: Create virtual network interface card
    azure_rm_networkinterface:
      resource_group: "{{ resource_group }}"
      name: "{{ nworker }}"
      virtual_network: "{{ vnet }}"
      subnet: "{{ subnet }}"
      public_ip_name: "{{ nworker }}"
      security_group: "{{ net_security_group }}"
      location: "{{ location }}"

  - name: Create VM
    azure_rm_virtualmachine:
      resource_group: "{{ resource_group }}"
      name: "{{ nworker }}"
      vm_size: Standard_F32s_v2
      managed_disk_type: Premium_LRS
      location: "{{ location }}"
      admin_username: azureuser
      ssh_password_enabled: false
      ssh_public_keys:
        - path: /home/azureuser/.ssh/authorized_keys
          key_data: "{{ ssh_key }}"
      network_interfaces: "{{ nworker }}"
      image:
        offer: RHEL
        publisher: RedHat
        sku: '7-LVM'
        version: latest
