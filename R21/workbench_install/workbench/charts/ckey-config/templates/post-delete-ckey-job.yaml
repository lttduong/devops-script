apiVersion: batch/v1
kind: Job
metadata:
  name: {{ template "name" . }}-post-delete-ckey
  namespace: "{{ .Values.global.BP_CONFIG_NAMESPACE }}"
  annotations:
    "helm.sh/hook": post-delete
    "helm.sh/hook-weight": "0"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    metadata:
      labels:
        name: {{ .Chart.Name }}-post-delete-ckey
    spec:
      dnsPolicy: {{ .Values.global.dns.policy }}
{{- if .Values.global.jobNodeAffinityRuleTemplate }}
{{ tpl .Values.global.jobNodeAffinityRuleTemplate . | indent 6 }}
{{- end }}
      restartPolicy: Never
      securityContext:
        runAsUser: 101
        fsGroup: 101
      containers:
      - name: {{ template "name" . }}-post-delete-ckey-client
        image: {{ .Values.global.registry }}/{{ .Values.global.config.ckey.configurator.image.name }}:{{ .Values.global.config.ckey.configurator.image.tag }}
        imagePullPolicy: {{ .Values.global.pullPolicy }}
        resources:
{{ toYaml .Values.global.config.ckey.configurator.resources | indent 10 }}
        command: ["keycloak_loader",
                  "--config={{ .Values.global.config.ckey.configurator.configDir }}",
                  "--data={{ .Values.global.config.ckey.configurator.dataDir }}",
                  "--realm={{ .Values.global.config.ckey.realm }}"]
        volumeMounts:
          - name: {{ template "name" . }}-post-delete-config-file
            mountPath: {{ .Values.global.config.ckey.configurator.configDir }}
          - name: {{ template "name" . }}-post-delete-client-remove
            mountPath: {{ .Values.global.config.ckey.configurator.dataDir }}/clients-remove
      volumes:
        - name: {{ template "name" . }}-post-delete-config-file
          secret:
            secretName: {{ .Values.global.config.ckey.configurator.secretName }}
        - name: {{ template "name" . }}-post-delete-client-remove
          secret:
            secretName: {{ template "name" . }}-post-delete-client-remove
