{{- if .Values.importConfig.enabled -}}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Values.global.releaseNamePrefix }}{{ template "name" . }}
  namespace: "{{ .Values.global.BP_CONFIG_NAMESPACE }}"
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "0"
    "helm.sh/hook-delete-policy": "before-hook-creation"
spec:
  template:
    metadata:
      labels:
        name: {{ template "name" . }}
    spec:
      securityContext:
        runAsUser: 101
        fsGroup: 101
{{- if .Values.global.jobNodeAffinityRuleTemplate }}
{{ tpl .Values.global.jobNodeAffinityRuleTemplate . | indent 6 }}
{{- end }}
      restartPolicy: {{ .Values.restartPolicy | quote }}
      containers:
      - name: {{ template "name" . }}
        image: "{{ .Values.image.nameAndTag }}"
        command: ["keycloak_loader",
                  "--config={{ .Values.configDir }}",
                  "--realm={{ .Values.realm }}",
                  "--data={{ .Values.dataDir }}"]
        volumeMounts:
        - name: {{ template "name" . }}-config-file
          mountPath: {{ .Values.configDir }}
        - name: {{ template "name" . }}-partial
          mountPath: {{ .Values.dataDir }}/partial
      volumes:
        - name: {{ template "name" . }}-config-file
          secret:
            secretName: {{ .Values.secretName }}
        - name: {{ template "name" . }}-partial
          configMap:
            name: {{ .Values.global.releaseNamePrefix }}{{ template "name" . }}-partial
{{- end -}}
