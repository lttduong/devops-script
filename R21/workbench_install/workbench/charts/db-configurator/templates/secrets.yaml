{{- range $index, $job:= .Values.jobs }}
{{- if .enabled }}
{{ $user := $job.username  }}
{{ $pword := tpl ($job.password | default $.Values.generatePassword) $ }}
{{ $nosUser := $job.nosUsername  | default "nosdb" }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ tpl $job.secretName $ }}
  labels:
    app: {{ template "name" $ }}
    chart: "{{ $.Chart.Name }}-{{ $.Chart.Version }}"
    release: "{{ $.Release.Name }}"
    heritage: "{{ $.Release.Service }}"
    backup: "true"
  annotations:
    "helm.sh/hook": {{ tpl ( $job.secretHook | default $.Values.global.helmHooks.secret.hook) $ | quote }}
    "helm.sh/hook-weight": {{ tpl ( $job.secretHookWeight | default $.Values.global.helmHooks.secret.weight) $ | quote }}
    "helm.sh/hook-delete-policy": "before-hook-creation"
type: Opaque
data:
  username: {{ $user | b64enc }}
  password: {{ $pword | b64enc }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ $.Release.Name}}-{{ $.Chart.Name}}-{{ tpl $job.secretName $ }}-script
  namespace: "{{ $.Values.global.BP_CONFIG_NAMESPACE }}"
  annotations:
    "helm.sh/hook": {{ tpl ( $job.scriptHook | default $.Values.global.helmHooks.secret.hook) $ | quote }}
    "helm.sh/hook-weight": {{ tpl ( $job.scriptHookWeight | default $.Values.global.helmHooks.secret.weight) $ | quote }}
    "helm.sh/hook-delete-policy": "hook-succeeded"
type: Opaque
data:
  script.sql: |-
    {{ $.Files.Get $job.sqlFile | replace "__USERNAME__" $user | replace "__PASSWORD__" $pword | replace "__NOS_USERNAME__" $nosUser| b64enc }}
{{- end }}
{{- end }}

