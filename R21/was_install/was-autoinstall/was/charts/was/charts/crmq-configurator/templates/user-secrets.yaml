{{- range $index, $entry := .Values.users }}
{{- if .enabled }}
{{ $user := tpl $entry.username $ }}
{{ $pword := tpl ($entry.password | default $.Values.generatePassword) $ }}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{ tpl $entry.secretName $ }}
  labels:
    app: {{ template "name" $ }}
    chart: "{{ $.Chart.Name }}-{{ $.Chart.Version }}"
    release: "{{ $.Release.Name }}"
    heritage: "{{ $.Release.Service }}"
  annotations:
    "helm.sh/hook": {{ tpl ( $entry.secretHook | default $.Values.global.helmHooks.secret.hook) $ | quote }}
    "helm.sh/hook-weight": {{ tpl ( $entry.secretHookWeight | default $.Values.global.helmHooks.secret.weight) $ | quote }}
    "helm.sh/hook-delete-policy": "before-hook-creation"
type: Opaque
data:
  username: {{ $user | b64enc }}
  password: {{ $pword | b64enc }}
{{- end }}
{{- end }}

