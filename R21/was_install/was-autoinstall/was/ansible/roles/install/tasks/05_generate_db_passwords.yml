---
- name: "Initialize DB password facts"
  set_fact:
    generated_db_passwords: {}
    passwordLength: 14
    passwordSigns: "@%^"

- debug:
    msg: "Generating passwords for: {{ db_password_helm_param_names }}"
    
- name: "Generating DB passwords"
  set_fact:
    generated_db_passwords: "{{ generated_db_passwords | combine ({ item : (lookup('password', '/dev/null length=1 chars=ascii_uppercase') +
                         lookup('password', '/dev/null length=1 chars=ascii_lowercase') +
                         lookup('password', '/dev/null length=1 chars=digits') +
                         lookup('password', '/dev/null length=1 chars={{ passwordSigns }}') +
                         lookup('password', '/dev/null length={{ passwordLength-4 }}
                                 chars=ascii_letters,digits,{{ passwordSigns }}') | shuffle | join | trim) } ) }}"
  with_items: "{{ db_password_helm_param_names }}"
  when: geoRedundancyActiveModeOrDisabled
  no_log: true

- name: "Set nosdb password fact"
  set_fact:
    helm_params: "{{ helm_params }} --set db-configurator.jobs.nosdb.password='{{ nosdbpassword }}'"
  when: nosdbpassword is defined

- name: "Add DB passwords to helm_params"
  set_fact:
    helm_params: "{{ helm_params }} --set {{ item.key }}='{{ item.value }}'"
  with_dict: "{{ generated_db_passwords }}"
  no_log: true
  
