---
# This task updates the helm_params variable with the generated encryption key password
#
# It is only executed if encryption_password_helm_param_names has been set, which in turn
# is only set if the ENCRYPTION_PASSWORD config var is not set (see product_facts.yml)
#
# see also: install_product.yml (which is where the helm_params is used)
#
- name: "Initialize encryption password facts"
  set_fact:
    generated_encryption_password: {}
    passwordLength: 24
    passwordSigns: "@%^"

- debug:
    msg: "Generating password for: {{ encryption_password_helm_param_names }}"

- name: "Generating encryption password"
  set_fact:
    generated_encryption_password: "{{ generated_encryption_password | combine ({ item : (lookup('password', '/dev/null length=1 chars=ascii_uppercase') +
                         lookup('password', '/dev/null length=1 chars=ascii_lowercase') +
                         lookup('password', '/dev/null length=1 chars=digits') +
                         lookup('password', '/dev/null length=1 chars={{ passwordSigns }}') +
                         lookup('password', '/dev/null length={{ passwordLength-4 }}
                                 chars=ascii_letters,digits,{{ passwordSigns }}') | shuffle | join | trim) } ) }}"
  with_items: "{{ encryption_password_helm_param_names }}"
  no_log: true

- name: "Add encryption password to helm_params"
  set_fact:
    helm_params: "{{ helm_params }} --set {{ item.key }}='{{ item.value }}'"
  with_dict: "{{ generated_encryption_password }}"
  no_log: true
