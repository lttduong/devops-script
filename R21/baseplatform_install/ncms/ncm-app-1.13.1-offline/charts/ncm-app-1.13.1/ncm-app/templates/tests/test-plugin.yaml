apiVersion: v1
kind: Pod
metadata:
  name: "{{ .Release.Name }}-plugin-test"
  annotations:
    "helm.sh/hook": test-success
  labels:
    component: "{{ .Values.service.name }}"
spec:
  containers:
  - name: {{ .Release.Name }}-plugin-test
    image: {{ .Values.global.registry }}/{{ .Values.image.name }}:{{ .Values.image.tag }}
    env:
      - name: NCM_HOST
        value: {{ template "ncmHost" . }}
      - name: NCM_PORT
        value: "{{ .Values.service.httpPort }}"
    volumeMounts:
        - name: tests
          mountPath: /test/
    command: ["sh", "-c", "bash /test/scale.sh;bash /test/heal.sh;bash /test/backup.sh;bash /test/restore.sh"]
  volumes:
    - name: tests
      configMap:
        name: "{{ .Release.Name }}-plugin-test-configmap" 
  restartPolicy: Never
