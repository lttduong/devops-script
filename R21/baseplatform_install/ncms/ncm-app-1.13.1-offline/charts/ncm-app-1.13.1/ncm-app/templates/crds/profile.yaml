{{ if and  (or (eq .Values.profileEndpoint "CRD") .Values.controller) (not (.Capabilities.APIVersions.Has "app.csf.nokia.com/v1")) }}
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: profiles.app.csf.nokia.com
  annotations:
    "helm.sh/resource-policy": keep
    helm.sh/hook: crd-install
spec:
  group: app.csf.nokia.com
  version: v1
  names:
    kind: Profile
    plural: profiles
    singular: profile
    shortNames:
    - prf
  scope: Cluster
  subresources:
    status: {}
  additionalPrinterColumns:
  - name: STATUS
    type: string
    description: The status of the profile
    JSONPath: .status.state
    priority: 1
  validation:
    openAPIV3Schema:
      properties:
        spec:
          properties:
            releases:
              type: array
            tags:
              type: array
            skipTags:
              type: array
            project:
              type: string
            traits:
              type: object
              properties:
                autoremove:
                  type: boolean
                failfast:
                  type: boolean
                parallel:
                  type: boolean
              required: ["autoremove","parallel","failfast"]
          required: ["traits"]
        status:
          properties:
            releases:
              type: array
            state:
              type: string
              enum:
               - ONBOARDED
               - DEPLOYING
               - DEPLOYED
               - TERMINATING
               - FAILED
               - ABORTING
               - COMPUTING
            message:
              type: string
          type: object
{{- end -}}
