apiVersion: v1
kind: Pod
metadata:
  name: "{{ .Release.Name }}-cert-test"
  annotations:
    "helm.sh/hook": test-success
  labels:
    component: "{{ .Values.service.name }}"
spec:
  containers:
  - name: {{ .Release.Name }}-cert-test
    image: {{ .Values.global.registry }}/{{ .Values.image.name }}:{{ .Values.image.tag }}
    env:
      - name: NCM_HOST
        value: {{ template "ncmHost" . }}
      - name: NCM_PORT
        value: "{{ .Values.service.httpPort }}"
    command:
    - bash
    - "-c"
    - |
      token=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
      result=$(curl -v -s --cacert /tmp/ca.crt --head -H "Authorization: Bearer ${token}" https://$NCM_HOST:$NCM_PORT/ncm/applications |grep HTTP |awk '{print $2}')
      echo $result
      if [[ $result = "200" ]]
      then
        exit 0
      else
        exit 1
      fi
    volumeMounts:
        - name: certificate
          mountPath: /tmp
          readOnly: true
  volumes:
    {{- if .Values.certSecretName }}
    - name: certificate
      secret:
        secretName: {{ .Values.certSecretName }}
    {{- else }}
    - name: certificate
      secret:
        secretName: {{ template "ncm-app.fullname" .}}-tls
    {{- end }}

  restartPolicy: Never
