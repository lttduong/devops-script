---
- name: "Set CRMQ nodes quorum size"
  block:
    - name: "Read resource profile"
      include_vars:
        file: "{{ files_path }}/charts/values/profiles/resources/{{BP_DEPLOYMENT_PROFILE.RESOURCES }}/crmq.yaml"
        name: resources_values
    - name: "Calculating CRMQ nodes quorum size"
      shell: "echo $(({{ resources_values.replicas }}/2+1))"
      register: crmq_quorum_size
    - name: "Set QUEUE_REPLICA_COUNT_PLACEHOLDER in dynamicConfig.parameters value"
      replace:
        dest: "{{ crmqConfigurationProfile.stat.path }}"
        regexp: '<QUEUE_REPLICA_COUNT_PLACEHOLDER>'
        replace: "{{ crmq_quorum_size.stdout }}"
  when: crmqResourcesProfile.stat.exists and crmqConfigurationProfile.stat.exists

- name: "Set namespace in CRMQ chart override file"
  replace:
    dest: "{{ crmqOverrideFile.stat.path }}"
    regexp: '<BP_NAMESPACE_PLACEHOLDER>'
    replace: "{{ BP_NAMESPACE }}"
  when: crmqOverrideFile.stat.exists

- name: "Set DNS domain in chart override file"
  replace:
    dest: "{{ crmqOverrideFile.stat.path }}"
    regexp: '<DNS_DOMAIN_PLACEHOLDER>'
    replace: "{{ svcDnsDomain }}"
  when: crmqOverrideFile.stat.exists
