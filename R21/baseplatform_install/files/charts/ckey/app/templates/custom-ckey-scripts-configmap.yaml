apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "keycloak.fullname" . }}-custom-ckey-scripts
  labels:
    app: {{ template "keycloak.fullname" . }}
    release: "{{ .Release.Name }}"
    heritage: "{{ .Release.Service }}"
data:
  keycloak-custom-script.sh: |
    # Install hot-modules
{{- range .Values.customProviders }}
{{- if eq .type "hotModule" }}
{{- range .resources }}
    cp -R /customProviders/hotModules/{{ . }} /opt/keycloak/standalone/deployments
{{- end }}
{{- end }}
{{- end }}

    # Install themes
{{- range .Values.customProviders }}
{{- if eq .type "theme" }}
{{- range .resources }}
    cp -R /customProviders/themes/{{ . }} /opt/keycloak/themes/
{{- end }}
{{- end }}
{{- end }}

    # Install modules and providers
{{- range .Values.customProviders }}
{{- if eq .type "moduleProvider" }}
    /opt/keycloak/bin/jboss-cli.sh --commands='embed-server --server-config=standalone-ha.xml, module add --name={{ .moduleDetails.name }} --resources={{- range $index, $resource := .moduleDetails.resources -}} {{- if $index -}} \\, {{- end -}} /customProviders/{{- $resource -}} {{- end }} {{- if .moduleDetails.dependencies }} --dependencies={{ join "\\," .moduleDetails.dependencies }} {{- end }}, /subsystem=keycloak-server:list-add(name=providers, value=module:{{ .moduleDetails.name }}'
{{- else if eq .type "moduleDependency" }}
    /opt/keycloak/bin/jboss-cli.sh --commands='embed-server --server-config=standalone-ha.xml, module add --name={{ .moduleDetails.name }} --resources={{- range $index, $resource := .moduleDetails.resources -}} {{- if $index -}} \\, {{- end -}} /customProviders/{{- $resource -}} {{- end }} {{- if .moduleDetails.dependencies }} --dependencies={{ join "\\," .moduleDetails.dependencies }} {{- end }}'
{{- end }}
{{- end }}

{{ .Values.customPreStartScript | indent 4 }}
