apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "zookeeper.name" . }}-dynamic-config
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "-1"
    "helm.sh/hook-delete-policy": before-hook-creation
    seccomp.security.alpha.kubernetes.io/allowedProfileNames: {{ .Values.global.seccompAllowedProfileNames }}
    seccomp.security.alpha.kubernetes.io/defaultProfileName: {{ .Values.global.seccompDefaultProfileName }}
  labels:
    app: {{ .Chart.Name }}
    release: {{ .Release.Name }}
data:
 dynamicfileorg.cfg.dynamic: |-
   {{- $replicas := .Values.servers | int }}
   {{- $root := . }}
   {{- range $replica := until $replicas }}
    {{- $serverid := add $replica 1 }}
    server.{{ $serverid }}={{ template "zookeeper.name" $root }}-{{ $replica }}.{{ template "zookeeper.name" $root }}-headless.{{ $root.Release.Namespace }}.svc{{ $root.Values.global.domainName }}:{{ $root.Values.serverPort }}:{{ $root.Values.leaderElectionPort }};0.0.0.0:2181
   {{- end }}

---
# Config map which holds the number of replicas before any scale operation.
# This config map is created and used by pre/post upgrade/rollback jobs to determine 
# the scale in/out direction when the user chooses to use the feature of scale via upgrade
{{ if .Values.global.enable_scale_via_upgrade }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "zookeeper.name" . }}-replicas
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation
    seccomp.security.alpha.kubernetes.io/allowedProfileNames: {{ .Values.global.seccompAllowedProfileNames }}
    seccomp.security.alpha.kubernetes.io/defaultProfileName: {{ .Values.global.seccompDefaultProfileName }}
  labels:
    app: {{ .Chart.Name }}
    release: {{ .Release.Name }}
data:
  replicas: {{ .Values.servers | quote }}
{{- end }}
---
