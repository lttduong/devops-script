{{- if .Values.persistence.pvc_auto_delete }}
{{- if .Values.rbac.enabled }}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ template "gen3gppxml.fullname" . }}-del-sa
  labels:
    release: {{ .Release.Name }}
  annotations:
    "helm.sh/hook": post-delete
    "helm.sh/hook-weight": "-2"
    "helm.sh/hook-delete-policy": hook-succeeded

---

apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ template "gen3gppxml.fullname" . }}-del-role
  namespace: "{{.Release.Namespace}}"
  annotations:
    "helm.sh/hook": post-delete
    "helm.sh/hook-weight": "-2"
    "helm.sh/hook-delete-policy": hook-succeeded

rules:
- apiGroups:
    - ""
  resources:
    - persistentvolumeclaims
  verbs:
    - get
    - list
    - delete

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name:  {{ template "gen3gppxml.fullname" . }}-del-gen3gppxml-rb
  labels:
    release: {{ .Release.Name }}
  annotations:
    "helm.sh/hook": post-delete
    "helm.sh/hook-weight": "-2"
    "helm.sh/hook-delete-policy": hook-succeeded

roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name:  {{ template "gen3gppxml.fullname" . }}-del-role
subjects:
  - kind: ServiceAccount
    name: {{ template "gen3gppxml.fullname" . }}-del-sa
    namespace: {{ .Release.Namespace }}

---
{{- end -}}

apiVersion: batch/v1
kind: Job
metadata:
  name: {{ template "gen3gppxml.postDeleteJobPod" . }}
  labels:
    app: {{ template "gen3gppxml.name" . }}
  annotations:
    "helm.sh/hook": post-delete
    "helm.sh/hook-weight": "-2"
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  template:
    metadata:
      labels:
        app: {{ template "gen3gppxml.name" . }}
      {{- if .Values.istio.enable }}
      annotations:
        sidecar.istio.io/inject: "false"
      {{- end }}
    spec:
      {{ if .Values.rbac.enabled }}
      serviceAccountName: {{ template "gen3gppxml.fullname" . }}-del-sa
      {{ else }}
      serviceAccountName: {{ template "gen3gpp.serviceAccountName" . }}
      {{ end }}
      restartPolicy: OnFailure
      containers:
      - name: {{ template "gen3gppxml.postDeletePvcContainer" . }}
        image: "{{ .Values.global.registry2 }}/{{ .Values.kubectl.image.repo }}:{{ .Values.kubectl.image.tag }}"
        resources:
{{ toYaml .Values.kubectl.jobResources | indent 10 }}
        command:
        - sh
        - "-c"
        - |
          kubectl delete pvc --namespace {{ .Release.Namespace }} -l app={{ template "gen3gppxml.name" . }},release={{ .Release.Name }}
{{- end -}}
