{{- include "elasticsearch.istio.initIstio" . }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ template "elasticsearch.client.fullname" . }}
  labels:
    component: elasticsearch
    role: client
    release: {{ .Release.Name | quote }}
  annotations:
    seccomp.security.alpha.kubernetes.io/allowedProfileNames: {{ .Values.global.seccompAllowedProfileNames }}
    seccomp.security.alpha.kubernetes.io/defaultProfileName: {{ .Values.global.seccompDefaultProfileName }}
{{- if .Values.custom }}
{{- if .Values.custom.annotations }}
{{- include "elasticsearch.csf-toolkit-helm.annotations" (tuple .Values.custom.annotations) | indent 4}}
{{- end }}
{{- end }}
spec:
  replicas: {{.Values.elasticsearch_client.replicas }}
  selector:
    matchLabels:
      component: elasticsearch
      role: client
      release: {{ .Release.Name | quote }}
  template:
    metadata:
      labels:
        component: elasticsearch
        role: client
        release: {{ .Release.Name | quote }}
        {{- if .Values.elasticsearch_client.podLabels }}
        {{- include "elasticsearch.custom-labels" (tuple .Values.elasticsearch_client.podLabels) | indent 8}}
        {{- end }}
      annotations:
        checksum/config: {{ include (print $.Template.BasePath "/es-secret.yaml") . | sha256sum }}
        {{- if and (.Values.istio.enabled) (ne $.istioVersion 1.4) }}
        traffic.sidecar.istio.io/excludeInboundPorts: "9300"
        traffic.sidecar.istio.io/excludeOutboundPorts: "9300"
        {{- end }}
    spec:
      ## Start of custom modification of original chart for CSFID-2092
      initContainers:
        - name: {{ template "elasticsearch.client.fullname" . }}-init
          image: {{ .Values.global.registry }}/{{ .Values.global.certsConverter.image.name }}:{{ .Values.global.certsConverter.image.tag }}
          imagePullPolicy: {{.Values.elasticsearch_master.ImagePullPolicy}}
          command: ["certs_converter"]
          args: ["--certs-dir={{ .Values.volumes.path.certs }}",
                 "--output={{ .Values.volumes.path.keys }}",
                 "--format=JKS"]
          env:
            - name: TS_PASS
              valueFrom:
                secretKeyRef:
                  name: {{ template "fullname" . }}
                  key: trustpass
            - name: KS_PASS
              valueFrom:
                secretKeyRef:
                  name: {{ template "fullname" . }}
                  key: keypass
          volumeMounts:
            - name: {{ template "fullname" . }}-tls
              mountPath: {{ .Values.volumes.path.certs }}
              readOnly: true
            - name: es-client-generated-certs
              mountPath: {{ .Values.volumes.path.keys }}
        - name: {{ template "elasticsearch.client.fullname" . }}-init-client-jks
          image: {{ .Values.global.registry }}/{{ .Values.global.certsConverter.image.name }}:{{ .Values.global.certsConverter.image.tag }}
          imagePullPolicy: {{.Values.elasticsearch_master.ImagePullPolicy}}
          command: ["certs_converter"]
          args: ["--certs-dir={{ .Values.volumes.path.certs }}",
                 "--output={{ .Values.volumes.path.keys }}",
                 "--format=JKS"]
          env:
            - name: TS_PASS
              valueFrom:
                secretKeyRef:
                  name: {{ template "fullname" . }}
                  key: trustpass
            - name: KS_PASS
              valueFrom:
                secretKeyRef:
                  name: {{ template "fullname" . }}
                  key: keypass
          volumeMounts:
            - name: {{ template "fullname" . }}-tls-client
              mountPath: {{ .Values.volumes.path.certs }}
              readOnly: true
            - name: es-client-generated-certs-client-jks
              mountPath: {{ .Values.volumes.path.keys }}
        - name: {{ template "elasticsearch.client.fullname" . }}-init-client-pem
          image: {{ .Values.global.registry }}/{{ .Values.global.certsConverter.image.name }}:{{ .Values.global.certsConverter.image.tag }}
          imagePullPolicy: {{.Values.elasticsearch_master.ImagePullPolicy}}
          command: ["certs_converter"]
          args: ["--certs-dir={{ .Values.volumes.path.certs }}",
                 "--output={{ .Values.volumes.path.keys }}",
                 "--format=PEM"]
          volumeMounts:
            - name: {{ template "fullname" . }}-tls-client
              mountPath: {{ .Values.volumes.path.certs }}
              readOnly: true
            - name: es-client-generated-certs-client-pem
              mountPath: {{ .Values.volumes.path.keys }}
      ## End of custom modification of original chart
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        {{- if .Values.es_securityContext.fsGroup }}
        fsGroup: {{ .Values.es_securityContext.fsGroup }}
        {{- end }}
        {{- if .Values.es_securityContext.supplementalGroups }}
        supplementalGroups: {{ .Values.es_securityContext.supplementalGroups }}
        {{- end }}
        {{- if .Values.es_securityContext.seLinuxOptions }}
        seLinuxOptions:
{{ toYaml .Values.es_securityContext.seLinuxOptions | indent 10 }}
        {{- end }}
      {{- if or .Values.elasticsearch_client.antiAffinity .Values.elasticsearch_client.nodeAffinity }}
      affinity:
      {{- end }}
      {{- if eq .Values.elasticsearch_client.antiAffinity "hard" }}
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - topologyKey: "kubernetes.io/hostname"
              labelSelector:
                matchLabels:
                  release: {{ .Release.Name | quote }}
                  component: elasticsearch
                  role: client
      {{- else if eq .Values.elasticsearch_client.antiAffinity "soft" }}
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 1
            podAffinityTerm:
              topologyKey: kubernetes.io/hostname
              labelSelector:
                matchLabels:
                  release: {{ .Release.Name | quote }}
                  component: elasticsearch
                  role: client
      {{- end }}
      {{- if .Values.elasticsearch_client.podAffinity }}
        podAffinity:
{{ toYaml .Values.elasticsearch_client.podAffinity | indent 10 }}
      {{- end }}
      serviceAccountName: {{ default ( default (printf "%s-es-sa" ( include "elasticsearch.fullname" . )) .Values.global.serviceAccountName ) .Values.serviceAccountName }}
      {{- with .Values.elasticsearch_client.nodeAffinity }}
        nodeAffinity:
{{ toYaml . | indent 10 }}
      {{- end }}
{{- if .Values.elasticsearch_client.nodeSelector }}
      nodeSelector:
{{ toYaml .Values.elasticsearch_client.nodeSelector | indent 8 }}
{{- end }}
{{- if .Values.elasticsearch_client.tolerations }}
      tolerations:
{{ toYaml .Values.elasticsearch_client.tolerations | indent 8 }}
{{- end }}
      {{- if (and (.Values.searchguard.enable) (.Values.searchguard.keycloak_auth) (.Values.istio.enabled)) }}
      {{- if eq (default "MESH_INTERNAL" .Values.searchguard.istio.extCkeyLocation) "MESH_INTERNAL" }}
      ## Adding host alias for ckey external hostname to a dummy IP for serviceentry when ckey location is MESH_INTERNAL
      hostAliases:
      - hostnames:
        - {{ .Values.searchguard.istio.extCkeyHostname }}
        ip: 1.2.3.4
      {{- else if .Values.searchguard.istio.extCkeyIP }}
      # Adding host alias for ckey external hostname to user-defined IP for DNS resolution from pod when ckey location is MESH_EXTERNAL
      hostAliases:
      - hostnames:
        - {{ .Values.searchguard.istio.extCkeyHostname }}
        ip: {{ .Values.searchguard.istio.extCkeyIP }}
      {{- end }}
      {{- end }}
      containers:
      - name: {{ template "elasticsearch.client.container" . }}
        {{- if .Values.searchguard.enable }}
        image: {{.Values.global.registry}}/{{.Values.searchguard.image.repo}}:{{.Values.searchguard.image.tag}}
        {{- else }}
        image: {{.Values.global.registry}}/{{.Values.elasticsearch_master.image.repo}}:{{.Values.elasticsearch_master.image.tag}}
        {{- end }}
        imagePullPolicy: {{.Values.elasticsearch_master.ImagePullPolicy}}
        resources:
{{ toYaml .Values.elasticsearch_client.resources | indent 10 }}
        securityContext:
          allowPrivilegeEscalation: false
          privileged: false
          capabilities:
             drop:
               - all
        readinessProbe:
          {{- if .Values.searchguard.enable }}
          {{ if or (.Values.istio.enabled) (not .Values.searchguard.http_ssl) }}
          exec:
            command:
              - "/bin/sh"
              - "-c"
              {{ if eq $.istioVersion 1.4 }}
              - "curl -s http://127.0.0.1:{{.Values.service.client_port}}/_searchguard/health?pretty | jq .status | grep -w UP"
              {{- else }}
              - "curl -s http://${HOSTNAME}:{{.Values.service.client_port}}/_searchguard/health?pretty | jq .status | grep -w UP"
              {{- end }}
          {{- else }}
          exec:
            command:
              - "/bin/sh"
              - "-c"
              - "curl -s -k https://${HOSTNAME}:{{.Values.service.client_port}}/_searchguard/health?pretty | jq .status | grep -w UP"
          {{- end }}
          {{- else }}
          exec:
            command:
              - "/bin/sh"
              - "-c"
              {{- if and (.Values.istio.enabled) (eq $.istioVersion 1.4) }}
              - curl  http://127.0.0.1:{{.Values.service.client_port}}/_cluster/health?pretty | jq .status | grep -E "green|yellow"
              {{- else }}
              - curl  http://${HOSTNAME}:{{.Values.service.client_port}}/_cluster/health?pretty | jq .status | grep -E "green|yellow"
              {{- end }}
          {{- end }}
          initialDelaySeconds: {{.Values.elasticsearch_client.readinessProbe.initialDelaySeconds }}
          periodSeconds: {{ .Values.elasticsearch_client.readinessProbe.periodSeconds }}  
          timeoutSeconds: {{ .Values.elasticsearch_client.readinessProbe.timeoutSeconds }}
          successThreshold: {{ .Values.elasticsearch_client.readinessProbe.successThreshold }}
          failureThreshold: {{ .Values.elasticsearch_client.readinessProbe.failureThreshold }}
        #to restart the client pod if java heap exceeds and java process gets killed. 
        livenessProbe:
          exec:
            command:
              - sh
              - -c
              - ps -A | grep java
          initialDelaySeconds: {{.Values.elasticsearch_client.livenessProbe.initialDelaySeconds }}
          periodSeconds: {{ .Values.elasticsearch_client.livenessProbe.periodSeconds }}
          timeoutSeconds: {{ .Values.elasticsearch_client.livenessProbe.timeoutSeconds }}
          successThreshold: {{ .Values.elasticsearch_client.livenessProbe.successThreshold }}
          failureThreshold: {{ .Values.elasticsearch_client.livenessProbe.failureThreshold }}
        env:
          - name: "CLUSTER_NAME"
            value: {{ printf "%s-%s" .Release.Namespace .Release.Name | quote }}
          - name: "NODE_MASTER"
            value: "false" 
          - name: "NODE_DATA"
            value: "false" 
          - name: "NODE_REMOTE_CLUSTER_CLIENT"
            value: "false"
          - name: "ES_JAVA_OPTS"
            value: "{{.Values.elasticsearch_client.es_java_opts}}"
          - name: "DISCOVERY_SERVICE"
            value: "{{ template "elasticsearch.fullname" . }}-discovery"
          - name: NETWORK_HOST
            {{- if .Values.istio.enabled }}
            value: "0.0.0.0"
            {{- else }}
            value: "{{.Values.network_host}}"
            {{- end }}
          - name: NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
          - name: NODE_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: ISTIO_ENABLED
            value: "{{ .Values.istio.enabled }}"
          {{- if .Values.searchguard.enable }}
          {{- if .Values.searchguard.ciphers }}
          - name: searchguard.ssl.http.enabled_ciphers
            value: "{{ template "elasticsearch.esciphers" . }}"
          {{- end }}
          - name: HTTP_SSL
            {{- if .Values.istio.enabled }}
            value: "false"
            {{- else }}
            value: "{{.Values.searchguard.http_ssl}}"
            {{- end }}
          {{- if or (.Values.istio.enabled) (not .Values.searchguard.http_ssl) }}
          - name: SG_INTERNAL_USERNAME
            valueFrom:
              secretKeyRef:
                name: {{ template "elasticsearch.fullname" . }}
                key: adminUsername
          - name: SG_INTERNAL_PWD
            valueFrom:
              secretKeyRef:
                name: {{ template "elasticsearch.fullname" . }}
                key: adminPwd
          {{- end }}
          {{- if not .Values.istio.enabled }}
          - name: "KEYSTORE_TYPE"
            value: "{{.Values.searchguard.keystore_type}}"
          - name: "TRUSTSTORE_TYPE"
            value: "{{.Values.searchguard.truststore_type}}"
          - name: "KEYSTORE_FILEPATH"
            value: "/etc/elasticsearch/certs/keystore.jks"
          - name: "KS_PWD"
            valueFrom:
              secretKeyRef:
                name: {{ template "elasticsearch.fullname" . }}
                key: keypass
          - name: "TRUSTSTORE_FILEPATH"
            value: "/etc/elasticsearch/certs/truststore.jks"
          - name: "TS_PWD"
            valueFrom:
              secretKeyRef:
                name: {{ template "elasticsearch.fullname" . }}
                key: trustpass
          - name: "CLIENT_KEYSTORE_FILEPATH"
            value: "/etc/elasticsearch/certs/client-keystore.jks"
          - name: "AUTH_ADMIN_DN"
            value: "{{.Values.searchguard.auth_admin_identity}}"
          - name: "NODES_DN"
            value: "{{ .Values.searchguard.nodes_dn }}"
          {{- else }}
          - name: "KEYSTORE_FILEPATH"
            value: "/etc/elasticsearch/certs/elasticsearch.jks"
          - name: "KS_PWD"
            valueFrom:
              secretKeyRef:
                name: {{ template "elasticsearch.fullname" . }}
                key: keypass
          - name: "TRUSTSTORE_FILEPATH"
            value: "/etc/elasticsearch/certs/root.jks"
          - name: "TS_PWD"
            valueFrom:
              secretKeyRef:
                name: {{ template "elasticsearch.fullname" . }}
                key: trustpass
          - name: "CLIENT_KEYSTORE_FILEPATH"
            value: "/etc/elasticsearch/certs/admin-keystore.jks"
          - name: "AUTH_ADMIN_DN"
            value: "CN=admin"
          - name: "NODES_DN"
            value: "CN=elasticsearch"
          {{- end }}
          - name: "SG_CONFIG_DIRECTORY"
            value: "/usr/share/elasticsearch/plugins/search-guard-7/sgconfig/"
          {{- end }}
        ports:
        - containerPort: {{.Values.service.master_port}}
          name: tcp-transport 
          protocol: TCP
        - containerPort: {{.Values.service.client_port}}
          name: tcp-rest
          protocol: TCP
        volumeMounts:
        - name: datadir
          mountPath: /data
        {{- if .Values.searchguard.enable }}
        ## Start of custom modification of original chart for CSFID-2092
        #- name: ssl
        #  mountPath: "/etc/elasticsearch/certs/"
        #  readOnly: true
        - name: es-client-generated-certs
          mountPath: "/etc/elasticsearch/certs/keystore.jks"
          subPath: "keystore.jks"
        - name: es-client-generated-certs
          mountPath: "/etc/elasticsearch/certs/truststore.jks"
          subPath: "truststore.jks"
        - name: es-client-generated-certs-client-jks
          mountPath: "/etc/elasticsearch/certs/client-keystore.jks"
          subPath: "keystore.jks"
        - name: es-client-generated-certs-client-pem
          mountPath: "/etc/elasticsearch/certs/admin.crt.pem"
          subPath: "tls.pem"
        - name: {{ template "fullname" . }}-tls-client
          mountPath: "/etc/elasticsearch/certs/admin.key.pem"
          subPath: "tls.key"
        ## End of custom modification of original chart
        - name: searchguard-config
          mountPath: "/usr/share/elasticsearch/plugins/search-guard-7/sgconfig/"
        {{- end }}
        ## Start of custom modification of original chart for CSFID-2092
        - name: es-config
          mountPath: "/etc/elasticsearch/elasticsearch.yml"
          readOnly: true
          subPath: "elasticsearch.yml"
        ## End of custom modification of original chart
      volumes:
      - emptyDir:
          medium: "" 
        name: "datadir"
      {{- if .Values.searchguard.enable }}
      ## Start of custom modification of original chart for CSFID-2092
      - name: {{ template "fullname" . }}-tls
        secret:
          secretName: {{ template "fullname" . }}-tls
      - name: es-client-generated-certs
        emptyDir: {}
      - name: {{ template "fullname" . }}-tls-client
        secret:
          secretName: {{ template "fullname" . }}-tls-client
          items:
          - key: ca.crt
            path: ca.crt
          - key: tls.key
            path: tls.key
          - key: tls.crt
            path: tls.crt
          - key: tls.key
            path: admin.key.pem
          - key: tls.crt
            path: admin.crt.pem
          defaultMode: 0600
      - name: es-client-generated-certs-client-jks
        emptyDir: {}
      - name: es-client-generated-certs-client-pem
        emptyDir: {}
      #- name: ssl
      #  secret:
      #    secretName: {{ template "elasticsearch.fullname" . }}
      #   items:
      #   {{- if not .Values.istio.enabled }}
      #   - key: keystore.jks
      #     path: keystore.jks
      #   - key: truststore.jks
      #     path: truststore.jks
      #    - key: client-keystore.jks
      #      path: client-keystore.jks
      #    - key: admin.crt.pem
      #      path: admin.crt.pem
      #    - key: admin.key.pem
      #      path: admin.key.pem
      #    {{- end }}
      ## End of custom modification of original chart
          {{- if (and (.Values.searchguard.keycloak_auth) (.Values.searchguard.base64_keycloak_rootca_pem) (not .Values.istio.enabled)) }}
          - key: keycloak-rootca.pem
            path: keycloak_rootca.pem
          {{- end }}
      - configMap:
          name: {{ template "elasticsearch.fullname" . }}-searchguard-config
        name: searchguard-config
      {{- end }}
      ## Start of custom modification of original chart for BASE-269
      - name: es-config
        configMap:
          name: {{ template "elasticsearch.fullname" . }}-es-config
          items:
            - key: elasticsearch.yml
              path: elasticsearch.yml
              mode: 0600
      ## End of custom modification of original chart
