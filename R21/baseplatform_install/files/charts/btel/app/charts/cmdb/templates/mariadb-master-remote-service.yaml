{{ if and (gt (int .Values.maxscale.count) 0) .Values.geo_redundancy.enabled }}
{{ $remote := .Values.geo_redundancy.remote }}
{{ $remote_parts := splitList ":" (default ":" $remote.master) }}
{{ $remote_ip := initial $remote_parts | join ":" | trimAll "[]" }}
{{ $tcp_remote_port := last $remote_parts }}
{{ if $remote.master }}
  ## Validate remote host and port and trigger error as needed
  {{- $ip := (required "A valid geo_redundancy.remote.master must be 'host:port'" $remote_ip) }}
  {{- $port := (required "A valid geo_redundancy.remote.master must be 'host:port'" $tcp_remote_port) }}
{{ end }}
{{ $service_name := .Values.services.endpoints.master.name | default (printf "%s-master-%s" (include "cmdb.fullname" .) $remote.name) }}
---
kind: Endpoints
apiVersion: v1
metadata:
  name: {{ $service_name }}
  labels:
    {{- include "cmdb-mariadb.labels" . | indent 4 }}
subsets:
  # To be added after install
{{- if $remote.master }}
  - addresses:
      - ip: "{{ $remote_ip }}"
    ports:
      - port: {{ $tcp_remote_port }}
        name: "tcp-mariadb"
{{- else }}
  []
{{- end }}
---
kind: Service
apiVersion: v1
metadata:
  name: {{ $service_name }}
  labels:
    {{- include "cmdb-mariadb.labels" . | indent 4 }}
  {{- if .Values.istio.enabled }}
    mtls-strict: "true"
  {{- end }}
spec:
{{- if $remote.master_remote_service_ip }}
  clusterIP: {{ $remote.master_remote_service_ip }}
{{- end }}
  ports:
  - name: "tcp-mariadb"
    port: 3306
  # To be modified after install
{{- if $remote.master }}
    targetPort: {{ $tcp_remote_port }}
{{- end }}

{{- if .Values.istio.enabled }}
{{- if semverCompare "<1.5" (toString .Values.global.istioVersion) }}
---
apiVersion: "authentication.istio.io/v1alpha1"
kind: "Policy"
metadata:
  name: {{ $service_name }}-mtls-authn
spec:
  targets:
  - name: {{ $service_name }}
  peers:
  - mtls:
      mode: STRICT
{{- end }}
---
apiVersion: networking.istio.io/v1alpha3
kind: DestinationRule
metadata:
  name: {{ $service_name }}-mlts-dr
spec:
  host: {{ $service_name }}
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL
{{- end }}

{{- end }}
