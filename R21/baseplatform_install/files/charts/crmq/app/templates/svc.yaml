---
apiVersion: v1
kind: Service
metadata:
  name: {{ template "rabbitmq.fullname" . }}
  labels:
    app: {{ template "rabbitmq.name" . }}
    chart: {{ template "rabbitmq.chart" .  }}
    release: "{{ .Release.Name }}"
    heritage: "{{ .Release.Service }}"
spec:
  type: ClusterIP
  clusterIP: None
  ports:
  - name: tcp-epmd
    port: 4369
    targetPort: tcp-epmd
  - name: tcp-dist
    port: 25672
    targetPort: tcp-dist
  - name: tcp-erlang
    port: 35672
    targetPort: tcp-erlang
  selector:
    app: {{ template "rabbitmq.name" . }}
    release: "{{ .Release.Name }}"
---
apiVersion: v1
kind: Service
metadata:
  {{- if .Values.svcName }}
  name: {{ .Values.svcName }}
  {{- else }}
  name: {{ template "rabbitmq.fullname" . }}-ext
  {{- end }}
  labels:
    app: {{ template "rabbitmq.name" . }}
    chart: {{ template "rabbitmq.chart" .  }}
    release: "{{ .Release.Name }}"
    heritage: "{{ .Release.Service }}"
  {{- if or .Values.svcAnnotations .Values.rabbitmq.prometheus.enabled }}
  annotations:
  {{- if .Values.svcAnnotations }}
{{ toYaml .Values.svcAnnotations | indent 4 }}
  {{- end }}
  {{- if .Values.rabbitmq.prometheus.enabled }}
{{ toYaml .Values.svcPrometheusAnnotations | indent 4 }}
  {{- end }}
  {{- end }}
spec:
  type: {{ .Values.serviceType }}
  ports:
  {{- if .Values.rabbitmq.amqpSvc }}
  - name: tcp-amqp
    port: {{ .Values.rabbitmq.amqpPort }}
    targetPort: tcp-amqp
    {{- if .Values.rabbitmq.nodePort }}
    nodePort: {{ .Values.rabbitmq.nodePort }}
    {{- end }}
  {{- end }}

  {{- if .Values.rabbitmq.management.enabled }}
  - name: tcp-stats
    port: {{ .Values.rabbitmq.management.port }}
    targetPort: tcp-stats
    {{- if .Values.rabbitmq.management.nodePort }}
    nodePort: {{ .Values.rabbitmq.management.nodePort }}
    {{- end }}
  {{- end }}

  {{- if .Values.rabbitmq.prometheus.enabled }}
  - name: tcp-prometheus
    port: {{ .Values.rabbitmq.prometheus.port }}
    targetPort: tcp-prometheus
    {{- if .Values.rabbitmq.prometheus.nodePort }}
    nodePort: {{ .Values.rabbitmq.prometheus.nodePort }}
    {{- end }}
  {{- end }}

  {{- if or .Values.rabbitmq.tls.certmanager.used (and .Values.rabbitmq.tls.cacert .Values.rabbitmq.tls.cert .Values.rabbitmq.tls.key) }}
  - name: tcp-server-ssl
    port: {{ .Values.rabbitmq.tls.ssl_port }}
    targetPort: tcp-server-ssl
    {{- if .Values.rabbitmq.tls.nodePort }}
    nodePort: {{ .Values.rabbitmq.tls.nodePort }}
    {{- end }}
  {{- end }}

  {{- if .Values.rabbitmq.mqtt.enabled }}
  - name: tcp-mqtttcp
    port: {{ .Values.rabbitmq.mqtt.DefaultTcpPort }}
    targetPort: tcp-mqtttcp
    {{- if .Values.rabbitmq.mqtt.tcpNodePort }}
    nodePort: {{ .Values.rabbitmq.mqtt.tcpNodePort }}
    {{- end }}
  {{- if .Values.rabbitmq.mqtt.enabledSsl }}
  - name: tcp-mqttssl
    targetPort: tcp-mqttssl
    port: {{ .Values.rabbitmq.mqtt.DefaultSslPort }}
    {{- if .Values.rabbitmq.mqtt.sslNodePort }}
    nodePort: {{ .Values.rabbitmq.mqtt.sslNodePort }}
    {{- end }}
  {{- end }}
  {{- end }}

  selector:
    app: {{ template "rabbitmq.name" . }}
    release: "{{ .Release.Name }}"
