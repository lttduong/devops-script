---
{{- if .Values.mariadb.metrics.enabled }}
#
# Verify that the metrics (exporter) sidecar is functioning and connected
# to the database
#
apiVersion: v1
kind: Pod
metadata:
  name: {{ template "cmdb.pod-prefix" . }}-verify-mysql-metrics
  labels:
    {{- include "cmdb-test.labels" . | indent 4 }}
  annotations:
    "helm.sh/hook": test-success
    "helm.sh/hook-weight": "1"
    "helm.sh/hook-delete-policy": hook-succeeded,before-hook-creation
    {{- if .Values.istio.enabled }}
    sidecar.istio.io/inject: "true"
    {{- end }}
spec:
  restartPolicy: Never
  {{- include "cmdb.sa" . | nindent 2 }}
  containers:
  - name: {{ template "cmdb.container-prefix" .}}test
    {{- include "cmdb-admin.image" . | indent 4 }}
    resources:
      requests:
        memory: 64Mi
        cpu: 100m
      limits:
        memory: 64Mi
        cpu: 100m
    command:
    - bash
    - "-c"
    - |
      . /usr/lib/admin/functions
      wait_istio_proxy
      for pod in $(kubectl get pod -n ${K8S_NAMESPACE} -l${K8S_LABELS},type=mariadb -o jsonpath={.items[*].metadata.name}); do
          kubectl exec -n ${K8S_NAMESPACE} ${pod} -c ${K8S_CONTAINER_PREFIX}metrics -- wget -q -O - localhost:9104/metrics | grep "^mysql_up 1" || {
              kill_istio_proxy
              exit 1
      }
      done
      kill_istio_proxy
      exit 0
    env:
    {{- include "cmdb-k8s.env" . | nindent 4 }}
{{- end }}
