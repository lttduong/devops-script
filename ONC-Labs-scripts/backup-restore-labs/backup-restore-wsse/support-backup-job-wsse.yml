---
- name: Recovery WSSE VM
  hosts: localhost
  connection: local
  collections:
   - azure.azcollectionvault_name

  vars_files:
    se_env_variables

  tasks:
   - name: Resume backup if VM is disabled
     shell: sudo  az backup protection resume --vault-name "{{ wsseVaultName }}" --resource-group "{{ resourceGroup }}" --container-name "{{ wsseName }}" --backup-management-type AzureIaasVM --item-name "{{ wsseName }}" --policy-name "{{ policyVault }}"
     ignore_errors: yes

   - name: Backup for new wsha
     shell: sudo az backup protection backup-now --resource-group "{{ resourceGroup }}" --vault-name "{{ wsseVaultName }}" --container-name "{{ wsseName }}" --item-name "{{ wsseName }}" --backup-management-type AzureIaaSVM --retain-until "{{ retainTime }}"

   - name: Get Job Backup Name after triggering backup wsse component 
     shell: sudo az backup job list --resource-group "{{ resourceGroup }}" --vault-name "{{ wsseVaultName }}" --query [0].name | sed 's/"//g' > ./wsseJobBackupKey.txt

  #  - name: Disable backup of VM
  #    shell: sudo az backup protection disable --resource-group "{{ resourceGroup }}" --vault-name "{{ wsseVaultName }}" --container-name "{{ wsseName}}" --item-name "{{ wsseName }}" --backup-management-type AzureIaaSVM -y

   - name: Pause 8 minutes to create recovery point
     pause: 
      minutes: 8  

   - name: Show Recovery Point
     shell: sudo az backup recoverypoint list --resource-group "{{ resourceGroup }}" --vault-name "{{ wsseVaultName }}" --backup-management-type AzureIaasVM --container-name "{{ wsseName }}" --item-name "{{ wsseName }}" --query [0].name --output tsv > ./wssePoint.txt

   - name: Show out
     shell: awk '{if(NR==1) print $1}' ./wssePoint.txt
     register: wssePoint

   - name: Print out Recovery Point has just backed up
     debug:
      msg: "This is Recovery Point : {{ wssePoint.stdout }} "
